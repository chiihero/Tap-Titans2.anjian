var winner_e="",winner_e10="",winner_e100="",winner_e1000="",winner_n="",winner_n_e="",winner_s1="",winner_s2="",winner_s3="",winner_s4="",winner_s5="",winner_value=0,winner_value10=0,winner_value100=0,winner_value1000=0,winner_svalue=0,obfuscate=0,white_rabbit=0,comeUndone="",recalc_litmus=!0,halp="1"==getURLParameter("halp");function updateRecalc(){1==$("#recalc_on").prop("checked")?($("#btnrecalcon").removeClass("btn-secondary").addClass("btn-primary"),$("#btnrecalcoff").removeClass("btn-primary").addClass("btn-secondary"),recalc_litmus=!0):($("#btnrecalcoff").removeClass("btn-secondary").addClass("btn-primary"),$("#btnrecalcon").removeClass("btn-primary").addClass("btn-secondary"),recalc_litmus=!1)}function getURLParameter(e){for(var a=window.location.search.substring(1).split("&"),t=0;t<a.length;t++){var l=a[t].split("=");if(l[0]==e)return l[1]}}function toggleSplash(e){1==$("#wet").prop("checked")?($("#btnwet").removeClass("btn-dark text-secondary").addClass("btn-info"),$("#btndry").removeClass("btn-info").addClass("btn-dark text-secondary")):($("#btndry").removeClass("btn-dark text-secondary").addClass("btn-info"),$("#btnwet").removeClass("btn-info").addClass("btn-dark text-secondary")),0!=e&&adjustWeights(!0)}function generateArtifacts(){$("#accept2").hide(),$("#artifacts").empty(),$("#daltifacts").empty(),$.each(artifacts.data,function(e,a){isNaN(a.level)&&(a.level=0);var t='<tr class="'+(1==a.active?"":"text-dark bg-secondary")+'" id="'+e+'row">';t+="<td>",t+='<input type="checkbox" aria-label="Checkbox to designate active status for '+a.name+'" id="'+e+'active"'+(1==a.active?' checked="checked"':"")+" onchange=\"updateActive('"+e+'\');" tabindex="-1">',t+="</td>",t+="<td>",t+='<label for="'+e+'active" id="basic-addon'+e+'">',t+='<span class="d-block d-sm-none">'+a.name+"</span>",t+='<span class="d-none d-sm-block">'+a.name+"</span>",t+="</label>",t+="</td>",t+="<td>",t+='<input id="'+e+'" value="'+(999999999999999<a.level?displayTruncated(a.level):avoidSci(a.level))+'" type="number" class="form-control artlvl" placeholder="0" aria-label="Level of '+a.name+'" aria-describedby="basic-addon'+e+'"onchange="updateArtifact(\''+e+"')\">",t+="</td>",t+="<td>",t+='<span class="badge" id="'+e+'expo"></span>',t+="</td>",t+="<td>",t+='<button class="badge badge-secondary" type="button" data-toggle="collapse" data-target="#'+e+'info" aria-expanded="false" aria-controls="'+e+'info" tabindex="-1">&#x00A0;i&#x00A0;</button>',t+="</td>",t+="</tr>",t+='<tr class="collapse" id="'+e+'info">',t+='<td colspan="5">',t+='<dl class="row">',t+='<dt class="col-3 col-sm-6 text-right">Name</dt>',t+='<dd class="col-9 col-sm-6">'+a.name+"</dd>",t+='<dt class="col-3 col-sm-6 text-right">Effect</dt>',t+='<dd class="col-9 col-sm-6" id="'+e+'effect"></dd>',t+='<dt class="col-3 col-sm-6 text-right">',t+='<span class="d-block d-sm-none">AD</span>',t+='<span class="d-none d-sm-block">Artifact Damage</span>',t+="</dt>",t+='<dd class="col-9 col-sm-6" id="'+e+'ad"></dd>',t+='<dt class="col-3 col-sm-6 text-right">',t+='<span class="d-block d-sm-none">Cost</span>',t+='<span class="d-none d-sm-block">Cost to Upgrade</span>',t+="</dt>",t+='<dd class="col-9 col-sm-6" id="'+e+'cost"></dd>',t+='<dt class="col-3 col-sm-6 text-right">',t+='<span class="d-block d-sm-none">Effc.</span>',t+='<span class="d-none d-sm-block">Efficiency</span>',t+="</dt>",t+='<dd class="col-9 col-sm-6" id="'+e+'eff"></dd>',t+="</dl>",t+="</td>",t+="</tr>",$("#artifacts").append(t);var l='<div class="col-3 col-sm-2 col-lg-1 border text-center">';l+="<strong>"+a.name+'</strong><br><span id="'+e+'dalt">'+displayTruncated(a.level)+"</span>",l+="</div>",$("#daltifacts").append(l)})}function determineTextColor(e){switch(e){case"red":return"text-danger";case"yellow":return"text-warning";case"blue":return"text-primary";case"green":return"text-success"}}function generateSkills(){$("#skills").empty(),$.each(skills.data,function(e,a){isNaN(a.level)&&(a.level=0);var t='<tr class="'+(1==a.active?"":"text-dark bg-secondary")+'" id="skill'+e+'row">';t+="<td>",t+='<input type="checkbox" aria-label="Checkbox to designate active status for '+a.name+'" id="skill'+e+'active"'+(1==a.active?' checked="checked"':"")+" onchange=\"updateActiveSkill('"+e+'\');" tabindex="-1">',t+="</td>",t+="<td>",t+='<label for="skill'+e+'active" id="basic-addonskill'+e+'">',t+='<span class="d-block d-sm-none '+determineTextColor(a.branch)+'">'+a.name+"</span>",t+='<span class="d-none d-sm-block '+determineTextColor(a.branch)+'">'+a.name+"</span>",t+="</label>",t+="</td>",t+="<td>",t+='<input id="skill'+e+'" value="'+a.level+'" type="tel" class="form-control artlvl" placeholder="0" aria-label="Level of '+a.name+'" aria-describedby="basic-addonskill'+e+'"onchange="updateSkill(\''+e+"')\">",t+="</td>",t+="<td>",t+='<span class="badge" id="skill'+e+'expo"></span>',t+="</td>",t+="<td>",t+='<button class="badge badge-secondary" type="button" data-toggle="collapse" data-target="#skill'+e+'info" aria-expanded="false" aria-controls="skill'+e+'info" tabindex="-1">&#x00A0;i&#x00A0;</button>',t+="</td>",t+="</tr>",t+='<tr class="collapse" id="skill'+e+'info">',t+='<td colspan="5">',t+='<dl class="row">',t+='<dt class="col-3 col-sm-6 text-right">Name</dt>',t+='<dd class="col-9 col-sm-6">'+a.name+"</dd>",t+='<dt class="col-3 col-sm-6 text-right">Effect</dt>',t+='<dd class="col-9 col-sm-6" id="skill'+e+'effect"></dd>',t+='<dt class="col-3 col-sm-6 text-right">Effect2</dt>',t+='<dd class="col-9 col-sm-6" id="skill'+e+'effect2"></dd>',t+='<dt class="col-3 col-sm-6 text-right">Effect3</dt>',t+='<dd class="col-9 col-sm-6" id="skill'+e+'effect3"></dd>',t+='<dt class="col-3 col-sm-6 text-right">',t+='<span class="d-block d-sm-none">Cost</span>',t+='<span class="d-none d-sm-block">Cost to Upgrade</span>',t+="</dt>",t+='<dd class="col-9 col-sm-6" id="skill'+e+'cost"></dd>',t+='<dt class="col-3 col-sm-6 text-right">',t+='<span class="d-block d-sm-none">Effc.</span>',t+='<span class="d-none d-sm-block">Efficiency</span>',t+="</dt>",t+='<dd class="col-9 col-sm-6" id="skill'+e+'eff"></dd>',t+="</dl>",t+="</td>",t+="</tr>",$("#skills").append(t)})}function adjustBoS(){var e=0;$.each(artifacts.data,function(a,t){"bos"!=a&&1==t.active&&-1==t.max&&(e+=t.rating)}),artifacts.data.bos.rating=e,artifacts=calculate(artifacts,"bos",!0,!0)}function updateActive(e){$("#"+e+"active").is(":checked")?(artifacts.data[e].active=1,$("#"+e+"row").removeClass("text-dark bg-secondary")):(artifacts.data[e].active=0,$("#"+e+"row").addClass("text-dark bg-secondary")),adjustBoS(),artifacts=calculate(artifacts,e,!0,!0)}function updateActiveSkill(e){$("#skill"+e+"active").is(":checked")?(skills.data[e].active=1,$("#skill"+e+"row").removeClass("text-dark bg-secondary")):(skills.data[e].active=0,$("#skill"+e+"row").addClass("text-dark bg-secondary")),calculateAllSkills()}function checkAllArtifacts(){$.each(artifacts.data,function(e,a){$("#"+e+"active").prop("checked",!0),artifacts.data[e].active=1,$("#"+e+"row").removeClass("text-dark bg-secondary"),$("#"+e).prop("readonly",!1)}),artifacts=calculateAll(artifacts,!0)}function checkAllSkills(){$.each(skills.data,function(e,a){$("#skill"+e+"active").prop("checked",!0),skills.data[e].active=1,$("#skill"+e+"row").removeClass("text-dark bg-secondary"),$("#skill"+e).prop("readonly",!1)}),calculateAllSkills()}function resetSkills(){$.each(skills.data,function(e,a){skills.data[e].level=0}),calculateSkillTotals(),calculateAllSkills()}function dalViewArtifact(e){e?$("#dal-tab").tab("show"):$("#artifacts-tab").tab("show")}function regenerateArtifacts(){$.each(artifacts.data,function(e,a){isNaN(a.level)&&(a.level=0),$("#"+e).val(999999999999999<a.level?displayTruncated(a.level):avoidSci(a.level)),$("#"+e+"dalt").text(displayTruncated(a.level));var t="";0<a.level&&null!=a.current_effect&&(t=displayEffect(a.current_effect,a.type)),t+=a.bonus,$("#"+e+"effect").empty().append(t),t="",0<a.level&&null!=a.current_ad&&(t=displayPct(a.current_ad)),$("#"+e+"ad").empty().append(t),t="",1==a.active&&null!=a.displayCost&&(t=a.displayCost+" Relics"),$("#"+e+"cost").empty().append(t),t="",1==a.active&&null!=a.efficiency&&""!=a.efficiency&&(t=a.efficiency.toExponential(12)),$("#"+e+"eff").empty().append(t),t="",null!=a.rating&&(t=a.rating.toFixed(2).replace(/\.?0+$/,"")),$("#"+e+"expo").empty().append(t).removeClass().addClass("badge").addClass("badge-"+a.color)}),storeData()}function regenerateSkills(){$.each(skills.data,function(e,a){isNaN(a.level)&&(a.level=0),$("#skill"+e).val(a.level),$("#"+a.nickname).text(a.level);var t="";0<a.level&&null!=a.current_effect&&(t=displayEffect(a.current_effect,a.type)),t+=a.bonus,$("#skill"+e+"effect").empty().append(t);t="";0<a.level&&null!=a.current_effect2&&0!=a.current_effect2&&-1!=a.current_effect2&&(t=displayEffect(a.current_effect2,a.type2)),t+=-1!=a.bonus2?a.bonus2:"",$("#skill"+e+"effect2").empty().append(t);t="";0<a.level&&null!=a.current_effect3&&0!=a.current_effect3&&-1!=a.current_effect3&&(t=displayEffect(a.current_effect3,a.type3)),t+=-1!=a.bonus3?a.bonus3:"",$("#skill"+e+"effect3").empty().append(t),t="",1==a.active&&null!=a.cost&&(t=a.cost+" SP"),$("#skill"+e+"cost").empty().append(t),t="",1==a.active&&null!=a.efficiency&&""!=a.efficiency&&(t=a.efficiency),$("#skill"+e+"eff").empty().append(t),t="",null!=a.rating1&&(t=a.rating1.toFixed(2).replace(/\.?0+$/,"")),null!=a.rating2&&(t+="/"+a.rating2.toFixed(2).replace(/\.?0+$/,"")),null!=a.rating3&&(t+="/"+a.rating3.toFixed(2).replace(/\.?0+$/,"")),$("#skill"+e+"expo").empty().append(t).removeClass().addClass("badge").addClass("badge-"+("info"==a.color?"success":a.color))}),storeData()}function updateArtifact(e){artifacts.data[e].level=parseFloat($("#"+e).val()),artifacts.totalAD=calculateTotalAD(artifacts.data,!0),1==recalc_litmus?adjustWeights(!0):storeData()}function updateSkill(e){var a=parseInt($("#skill"+e).val());skills.data[e].level=skills.data[e].max<a?skills.data[e].max:a,$("#skill"+e).val(a),adjustWeights(!1)}function countArtifacts(e){var a=0;return $.each(e,function(e,t){t.level>0&&a++}),a}function determineAverage(e){var a=countArtifacts(e),t=0,l=0;return $.each(e,function(e,a){obfuscate++,a.level>0&&(t+=a.level)}),a>0&&t>0&&(l=t/a),l}function determineArtifactStepWinner(e){var a="";switch(e){case 1:a=winner_e;break;case 10:a=winner_e10;break;case 100:a=winner_e100;break;case 1e3:a=winner_e1000}return a}function determineArtifactStep(e,a){var t=0;switch(a){case 1:t=1;break;case 10:t=e.efficiency10_int;break;case 100:t=e.efficiency100_int;break;case 1e3:t=e.efficiency1000_int}return t}function determineArtifactCost(e,a){var t=0;switch(a){case 1:t=e.cost;break;case 10:t=e.efficiency10_cost;break;case 100:t=e.efficiency100_cost;break;case 1e3:t=e.efficiency1000_cost}return t}function dowsingRod(e,a,t,l=0){var s=0,c=calculateArtifactEfficiencyCost(e,a);if(t<c)return s;for(obfuscate++,t-=c=calculateArtifactEfficiencyCost(e,a-l),s++,e.level+=a-l;0<t&&(0!=c||1===s);)obfuscate++,0<(t-=c=calculateArtifactEfficiencyCost(e,a))&&(s++,e.level+=a);return s*a-l}function processPct(e,a,t,l,s){var c=a.level*a.ad,i=1+a.effect*Math.pow(a.level,Math.pow(1+(a.cexpo-1)*Math.min(a.grate*a.level,a.gmax),a.gexpo));switch(a.dime){case 0:break;case 1:0<artifacts.data.tmg.level&&(i*=10);break;case 2:0<artifacts.data.ttof.level&&(i*=10)}var n=0,r=0,o=0,d=0,f=0,p=a.level,u=!1;if(1==a.active){if(0==a.level){u=!0,p=1;var v=countArtifacts(artifacts.data)+1;o=artifact_costs[v]}if(-1==a.max){for(var m=1e57,_=a.level;m>.1&&0===d;)_>m&&(_%=m),d=dowsingRod(a,m,t,_),a.level=p,f+=d,o+=r=calculateArtifactEfficiencyCost(a,d),t-=r,a.level+=d,p=a.level,m/=10;return 1==s&&0==u?(u_relics-=o,upgrades.steps.push({k:e,levels:f,cost:o,remaining:u_relics}),f):0<f?calculateArtifactEfficiency(a,o,f,c,i,l):-1}if(a.max>a.level)for(n=a.max-a.level;0<n;){if(obfuscate++,(r=calculateArtifactEfficiencyCost(a,n))<=t)return 1==s&&0==u?(u_relics-=r,upgrades.steps.push({k:e,levels:n,cost:r,remaining:u_relics}),n):0<n?calculateArtifactEfficiency(a,r,n,c,i,l):-1;n--}}return-1}function optimizePct(){obfuscate++;var e="",a=0,t=0,l=0,s=Math.floor(u_relics*(u_step/100));if($.each(u_temp_artifacts.data,function(c,i){obfuscate++;var n=i.level;t=processPct(c,i,s,u_temp_artifacts.totalAD,!1),i.level=n,t>a&&(0==i.level?t>l&&(""==winner_n_e||winner_n_e<i.rating)&&(winner_n=c,winner_n_e=i.rating,l=t):(e=c,a=t))}),""!=e){var c=u_temp_artifacts.data[e].level,i=processPct(e,u_temp_artifacts.data[e],s,u_temp_artifacts.totalAD,!0);u_temp_artifacts.data[e].level=c,u_temp_artifacts.data[e].level+=i,u_temp_artifacts.totalAD=calculateTotalAD(u_temp_artifacts.data,!1)}if(""!=e&&u_relics>=u_threshhold){var n=100*(1-(u_relics>0?u_relics/(u_orelics-u_threshhold):0/u_orelics));$("#progress").width(n+"%"),$("#progress").prop("aria-valuenow",n),buffer=u_obuffer,window.setTimeout(optimizePct,1)}else{n=100;$("#progress").width(n+"%"),$("#progress").prop("aria-valuenow",n),$("#progress").removeClass("progress-bar-striped progress-bar-animated"),renderPctSuggestions(u_temp_artifacts)}}function optimize(){for(var e=determineArtifactStepWinner(u_step),a=determineArtifactStep(u_temp_artifacts.data[e],u_step),t=determineArtifactCost(u_temp_artifacts.data[e],u_step);buffer-- >0&&u_relics>=t;)obfuscate++,null==upgrades[e]?upgrades[e]=a:upgrades[e]+=a,u_relics-=t,null==u_temp_artifacts.data[e].upgradeCost?u_temp_artifacts.data[e].upgradeCost=t:u_temp_artifacts.data[e].upgradeCost+=t,u_temp_artifacts.data[e].level+=a,u_temp_artifacts=calculate(u_temp_artifacts,e,!1,!1),e=determineArtifactStepWinner(u_step),a=determineArtifactStep(u_temp_artifacts.data[e],u_step),t=determineArtifactCost(u_temp_artifacts.data[e],u_step);if(u_relics>=t){var l=100*(1-(u_relics>0?u_relics/u_orelics:0/u_orelics));$("#progress").width(l+"%"),$("#progress").prop("aria-valuenow",l),buffer=u_obuffer,window.setTimeout(optimize,1)}else{l=100;$("#progress").width(l+"%"),$("#progress").prop("aria-valuenow",l),$("#progress").removeClass("progress-bar-striped progress-bar-animated"),renderSuggestions(u_temp_artifacts)}}function generateUpgrades(){0==recalc_litmus&&adjustWeights(!0),obfuscate=0,white_rabbit=new Date,$("#export_wrap").hide(),$("#import_wrap").hide(),$("#new_artifact").empty(),$("#pudding").empty(),$("#accept").empty(),$("#suggestions").empty(),$("#progressBar").hide(),$("#progress").width("0%"),$("#progress").prop("aria-valuenow",0),$("#progress").addClass("progress-bar-striped progress-bar-animated"),$("#progressBar").show(),$("#relicsuggs").show(),$("#relicreccs").hide(),null==$("#ocd").val()&&$("#ocd").val("1"),storeData();var e=0;$.each(artifacts.data,function(a,t){0==t.level&&t.rating>=3&&t.rating>e&&"1"==t.active&&(e=t.rating,winner_n=a)}),u_relics=new Decimal((""==$("#relics").val()?0:$("#relics").val())+"."+(""==$("#relics_decimal").val()?0:$("#relics_decimal").val())),buffer=Math.pow(10,$("#relic_factor").val().substr(1)),u_relics=u_relics.mul(buffer).toNumber(),u_orelics=u_relics,u_obuffer=buffer,u_threshhold=new Decimal((""==$("#spend").val()?95:$("#spend").val())+"."+(""==$("#spend_decimal").val()?0:$("#spend_decimal").val())),u_threshhold=1-u_threshhold.div(100).toNumber(),u_threshhold*=u_relics,upgrades={},u_temp_artifacts=$.extend(!0,{},artifacts);var a=!1;$.each(u_temp_artifacts.data,function(e,t){t.level>0&&(a=!0)}),0!=a?u_relics>0?"pct"==$("#ocd").val().substring(0,3)?(u_step=parseInt($("#ocd").val().substring(3)),upgrades.steps=[],window.setTimeout(optimizePct,1)):(u_step=parseInt($("#ocd").val()),window.setTimeout(optimize,1)):renderSuggestions(u_temp_artifacts):$("#suggestions").empty().append("<p>您必须至少启用一个神器才能接收优化建议方案。</p>")}function renderSuggestions(e){""!=winner_n&&$("#new_artifact").empty().append("<em>提示：未拥有的神器里这个对你影响最大（"+artifacts.data[winner_n].name+"）</em>"),winner_e="",winner_e10="",winner_e100="",winner_e1000="",winner_n="",winner_n_e="";var a="",t=!1;if($.each(upgrades,function(e,a){t=!0}),0==t)return $("#pudding").empty(),$("#suggestions").empty().append("<p>您无法承担进行下一次升级的圣物消耗。 请积攒圣物或尝试降低购买指数或关闭四舍五入。</p>"),$("#accept").empty().append('<button type="button" class="btn btn-danger" onclick="rejectSuggestions();">取消</button>'),void(relics=0);$.each(artifacts.data,function(t,l){t in upgrades&&(a+='<div class="card bg-dark border border-secondary '+(1==$("#wolf").prop("checked")?"bg-dark":"")+'">',a+='<div class="card-header d-flex justify-content-between align-items-center" id="'+t+'deetsh">',a+="<span>",a+='<span class="d-inline d-sm-none">'+l.name+"</span>",a+='<span class="d-none d-sm-inline">'+l.name+"</span>",a+=" <small>"+displayTruncated(l.level)+"&#x00A0;=>&#x00A0;"+displayTruncated(e.data[t].level)+"</small>",a+='<span class="badge badge-'+l.color+' ml-3">+'+upgrades[t]+"</span><br />",a+="<small>花费 "+displayTruncated(e.data[t].upgradeCost)+" 圣物</small>",a+="</span>",a+='<button class="badge badge-secondary" type="button" data-toggle="collapse" data-target="#'+t+'deets" aria-expanded="false" aria-controls="'+t+'deets">&#x00A0;i&#x00A0;</button>',a+="</div>",a+='<div class="collapse" id="'+t+'deets" aria-labelledby="'+t+'deetsh" data-parent="#suggestions">',a+='<div class="card-body">',a+='<dl class="row">',a+='<dt class="col-3 col-sm-6 text-right">Effect</dt>',a+='<dd class="col-9 col-sm-6">'+displayEffect(l.current_effect,l.type)+" => "+displayEffect(e.data[t].current_effect,artifacts.data[t].type)+"</dd>",a+='<dt class="col-3 col-sm-6 text-right">',a+='<span class="d-block d-sm-none">AD</span>',a+='<span class="d-none d-sm-block">Artifact Damage</span>',a+="</dt>",a+='<dd class="col-9 col-sm-6">'+displayPct(l.current_ad)+" => "+displayPct(e.data[t].current_ad)+"</dd>",a+="</dl>",a+="</div>",a+="</div>",a+="</div>")});var l=(new Date).getTime()-white_rabbit.getTime();$("#pudding").empty().append("共执行计算 "+obfuscate+"次 在 "+(l/1e3).toFixed(3)+"秒内 ("+(obfuscate/l*1e3).toFixed(3)+"/s)"),$("#suggestions").empty().append(a),$("#accept2").show(),$("#accept").empty().append('<button type="button" class="btn btn-primary" onclick="acceptSuggestions();">完成</button><button type="button" class="btn btn-danger" onclick="rejectSuggestions();">取消</button>')}function renderPctSuggestions(e){""!=winner_n&&$("#new_artifact").empty().append("<em>提示：未拥有的神器里这个对你影响最大（"+artifacts.data[winner_n].name+"）</em>"),winner_e="",winner_e10="",winner_e100="",winner_e1000="",winner_n="",winner_n_e="";var a="<ol>";if(0==upgrades.steps.length)return $("#pudding").empty(),$("#suggestions").empty().append("<p>您无法承担进行下一次升级的圣物消耗。 请积攒圣物或尝试降低购买指数或关闭四舍五入。</p>"),$("#accept").empty().append('<button type="button" class="btn btn-danger" onclick="rejectSuggestions();">取消</button>'),void(u_relics=0);$.each(upgrades.steps,function(e,t){a+='<li class="mb-2">',a+="<span>"+artifacts.data[t.k].name+"</span>",a+='<sup class="text-secondary">['+artifacts.data[t.k].sort_order+"]</sup>",a+='<span class="badge badge-'+artifacts.data[t.k].color+' ml-3">+'+displayTruncated(t.levels)+"</span><br />",a+="<small>花费： "+displayTruncated(t.cost)+" // 剩余： "+displayTruncated(t.remaining)+"</small>",a+="</li>"}),a+="</ol>";var t=(new Date).getTime()-white_rabbit.getTime();$("#pudding").empty().append("共执行计算 "+obfuscate+"次 在 "+(t/1e3).toFixed(3)+"秒内 ("+(obfuscate/t*1e3).toFixed(3)+"/s)"),$("#suggestions").empty().append(a),$("#accept2").show(),$("#accept").empty().append('<button type="button" class="btn btn-primary" onclick="acceptPctSuggestions();">完成</button><button type="button" class="btn btn-danger" onclick="rejectSuggestions();">取消</button>')}function acceptPctSuggestions(){gtag("event","Upgrades",{event_category:"Upgrades",event_action:"Accept",event_label:"Artifacts Pct"}),$.each(upgrades.steps,function(e,a){artifacts.data[a.k].level+=a.levels}),artifacts.totalAD=calculateTotalAD(artifacts.data,!0),$("#new_artifact").empty(),$("#accept").empty(),$("#accept2").hide(),$("#suggestions").empty(),$("#relics").val(""),$("#relics_decimal").val(""),$("#relicsuggs").hide(),$("#relicreccs").show(),adjustWeights(!0)}function acceptSuggestions(){gtag("event","Upgrades",{event_category:"Upgrades",event_action:"Accept",event_label:"Artifacts"}),$.each(upgrades,function(e,a){artifacts.data[e].level+=a}),artifacts.totalAD=calculateTotalAD(artifacts.data,!0),$("#new_artifact").empty(),$("#accept").empty(),$("#accept2").hide(),$("#suggestions").empty(),$("#relics").val(""),$("#relics_decimal").val(""),$("#relicsuggs").hide(),$("#relicreccs").show(),adjustWeights(!0)}function rejectSuggestions(){$("#new_artifact").empty(),$("#accept").empty(),$("#accept2").hide(),$("#suggestions").empty(),$("#relics").val(""),$("#relics_decimal").val(""),$("#relicsuggs").hide(),$("#relicreccs").show(),calculateAll(artifacts,!0)}function skillEff(e,a){var t=!1,l=!1,s=!1;0<a.level&&(t=a.levels[a.level].bonus),-1!=a.bonus2&&(l=a.level>0?a.levels[a.level].bonus2:"X"),-1!=a.bonus3&&(s=a.level>0?a.levels[a.level].bonus3:"X"),skills.data[e].current_effect=t,skills.data[e].current_effect2=l,skills.data[e].current_effect3=s;var c=1;a.max<a.level&&(a.level=a.max,skills.data[e].level=a.max,$("#skill"+e).val(a.max));$("#active").val();if(a.max>a.level){!1===t&&(t=0),skills.data[e].cost=a.levels[a.level+1].cost;for(var i=a.level+1;i>0;)a.levels[i--].cost;var n=a.levels[a.level+1].bonus;"aaw"==e&&0<a.level&&(n=Math.pow(n,a.levels[a.level+1].bonus3),t=Math.pow(t,a.levels[a.level].bonus3));var r=Math.abs(n)/(0<a.level&&0!=t&&"X"!=t?Math.abs(t):Math.abs(n/2));if(c*=Math.pow(r,0==a.rating1?1e-5:a.rating1),!1!==l){var o=a.levels[a.level+1].bonus2;if(0!=o){var d=Math.abs(o)/(0<a.level&&0!=l&&"X"!=l?Math.abs(l):Math.abs(o/2)),f=Math.pow(d,0==a.rating2?1e-5:a.rating2);"cs"==e?c/=f:c*=f}}if(!1!==s){var p=a.levels[a.level+1].bonus3;if(0!=p){var u=Math.abs(p)/(0<a.level&&0!=s&&"X"!=s?Math.abs(s):Math.abs(p/2));c*=Math.pow(u,0==a.rating3?1e-5:a.rating3)}}var v=Decimal(c).pow(1/a.levels[a.level+1].cost).sub(1).toNumber();skills.data[e].efficiency=v}}function oldEff(e,a,t){var l=t.level*t.ad,s=1+t.effect*Math.pow(t.level,Math.pow(1+(t.cexpo-1)*Math.min(t.grate*t.level,t.gmax),t.gexpo));switch(t.dime){case 0:break;case 1:0<artifacts.data.tmg.level&&(s*=10);break;case 2:0<artifacts.data.ttof.level&&(s*=10)}if(e.data[a].current_ad=l,e.data[a].current_effect=s,-1==t.max||t.max>t.level){var c=Math.pow(t.level+1,t.cexpo)*t.ccoef;e.data[a].cost=c,e.data[a].displayCost=displayTruncated(c),e.data[a].efficiency=calculateArtifactEfficiency(t,c,1,l,s,e.totalAD);var i=calculateArtifactEfficiencyInterval(t,10),n=calculateArtifactEfficiencyCost(t,i);e.data[a].efficiency10_int=i,e.data[a].efficiency10_cost=n,e.data[a].efficiency10=calculateArtifactEfficiency(t,n,i,l,s,e.totalAD);var r=calculateArtifactEfficiencyInterval(t,100),o=calculateArtifactEfficiencyCost(t,r);e.data[a].efficiency100_int=r,e.data[a].efficiency100_cost=o,e.data[a].efficiency100=calculateArtifactEfficiency(t,o,r,l,s,e.totalAD);var d=calculateArtifactEfficiencyInterval(t,1e3),f=calculateArtifactEfficiencyCost(t,d);e.data[a].efficiency1000_int=d,e.data[a].efficiency1000_cost=f,e.data[a].efficiency1000=calculateArtifactEfficiency(t,f,d,l,s,e.totalAD)}return e}function calculateArtifactEfficiencyInterval(e,a){var t=(e.level+a)%a;return 0!=t&&(a-=t),0<e.max&&e.level+a>e.max&&(a=e.max-e.level),a}function calculateArtifactEfficiencyCost(e,a){return obfuscate++,e.ccoef/(e.cexpo+1)*Math.pow(e.level+a,e.cexpo+1)-e.ccoef/(e.cexpo+1)*Math.pow(e.level,e.cexpo+1)}function calculateArtifactEfficiency(e,a,t,l,s,c){obfuscate++;var i=1+e.effect*Math.pow(e.level+t,Math.pow(1+(e.cexpo-1)*Math.min(e.grate*(e.level+t),e.gmax),e.gexpo));switch(e.dime){case 0:break;case 1:0<artifacts.data.tmg.level&&(i*=10);break;case 2:0<artifacts.data.ttof.level&&(i*=10)}var n=Math.abs(i)/Math.abs(s),r=Math.pow(n,e.rating),o=1+((e.level+t)*e.ad-l)/c;return Math.abs((r*o-1)/a)}function newEff(e,a,t,l,s,c){if(e.data[a].current_ad="",e.data[a].current_effect="",t.level=1,s+=calculateArtifactEfficiencyCost(t,-1==t.max||t.max>l?l:t.max),t.level=0,-1==t.max||t.max>l)var i=1+t.effect*Math.pow(l,Math.pow(1+(t.cexpo-1)*Math.min(t.grate*l,t.gmax),t.gexpo));else i=1+t.effect*Math.pow(t.max,Math.pow(1+(t.cexpo-1)*Math.min(t.grate*t.max,t.gmax),t.gexpo));var n=Math.pow(Math.abs(i),t.rating),r=1+l*t.ad/e.totalAD,o=Math.abs((n*r-1)/s/c);return e.data[a].efficiency=o,e}function calculateTotalAD(e,a){var t=0;return $.each(e,function(e,a){obfuscate++,t+=a.level*a.ad}),1==a&&$("#adsanity").text(displayPct(t*(""!=artifacts.data.hsw.current_effect?artifacts.data.hsw.current_effect:1))),t}function calculateSkillTotals(){skills.totals.SP=0,skills.totals.red=0,skills.totals.yellow=0,skills.totals.blue=0,skills.totals.green=0,$.each(skills.data,function(e,a){if(a.level>a.max&&(a.level=a.max,skills.data[e].level=a.max,$("#skill"+e).val(a.max)),a.level>0)for(var t=1;t<=a.level;){var l=a.levels[t];skills.totals.SP+=l.cost,skills.totals[a.branch]+=l.cost,t++}}),$("#totalSP").text(skills.totals.SP),$("#totalSPred").text(skills.totals.red),$("#totalSPyellow").text(skills.totals.yellow),$("#totalSPblue").text(skills.totals.blue),$("#totalSPgreen").text(skills.totals.green)}function calculate(e,a,t,l){obfuscate+=1;var s=countArtifacts(artifacts.data)+1,c=artifact_costs[s],i=determineAverage(artifacts.data),n=e.data[a];if(e.data[a].efficiency="",e.data[a].cost="",e.data[a].displayCost="",n.level>0&&1==n.active)n.current_ad,(e=oldEff(e,a,n)).data[a].current_ad;else 0==n.level&&-1!=c&&1==n.active&&!0===l?e=newEff(e,a,n,i,c,Object.keys(artifact_costs).length-3-s):(e.data[a].current_ad="",e.data[a].current_effect="");return determineArtifactWinner(e,t,c,l),e.totalAD=calculateTotalAD(e.data,t),e}function determineArtifactWinner(e,a,t,l){winner_e="",winner_e10="",winner_e100="",winner_e1000="";var s="",c="",i=0;winner_value=0,winner_value10=0,winner_value100=0,winner_value1000=0,$.each(e.data,function(a,n){obfuscate++,n.efficiency>winner_value&&(n.level>0&&1==n.active&&(-1==n.max||n.max>n.level)?(winner_e=a,winner_value=n.efficiency):0==n.level&&-1!=t&&1==n.active&&!0===l&&e.data[a].efficiency>i&&(""==c||c<e.data[a].rating)&&(s=a,c=e.data[a].rating,i=e.data[a].efficiency)),obfuscate++,n.efficiency10>winner_value10&&n.level>0&&1==n.active&&(-1==n.max||n.max>n.level)&&(winner_e10=a,winner_value10=n.efficiency10),obfuscate++,n.efficiency100>winner_value100&&n.level>0&&1==n.active&&(-1==n.max||n.max>n.level)&&(winner_e100=a,winner_value100=n.efficiency100),obfuscate++,n.efficiency1000>winner_value1000&&n.level>0&&1==n.active&&(-1==n.max||n.max>n.level)&&(winner_e1000=a,winner_value1000=n.efficiency1000)}),!0===a&&(regenerateArtifacts(),winner_n=""!=s&&e.data[s].efficiency>=winner_value&&"1"==e.data[s].active?s:"")}function determineSkillWinner(e){winner_svalue=0;var a="";return $.each(skills.data,function(t,l){if(-1!=e.indexOf(t))return!0;l.efficiency>winner_svalue&&l.max>l.level&&(skills.totals[l.branch]>=tiers[l.tier]&&(-1==l.prereq||0<skills.data[l.prereq].level)?(a=t,winner_svalue=l.efficiency):skills.totals[l.branch]<tiers[l.tier]&&-1==skills.data[l.prereq].prereq&&-1==e.indexOf(l.prereq)?(a=l.prereq,winner_svalue=l.efficiency):skills.totals[l.branch]>=tiers[l.tier]&&-1==skills.data[skills.data[l.prereq].prereq].prereq?0<skills.data[skills.data[l.prereq].prereq].level&&-1==e.indexOf(l.prereq)?(a=l.prereq,winner_svalue=l.efficiency):-1==e.indexOf(skills.data[l.prereq].prereq)&&(a=skills.data[l.prereq].prereq,winner_svalue=l.efficiency):skills.totals[l.branch]>=tiers[l.tier]&&-1==skills.data[skills.data[skills.data[l.prereq].prereq].prereq].prereq&&(0<skills.data[skills.data[skills.data[l.prereq].prereq].prereq].level?0<skills.data[skills.data[l.prereq].prereq].level&&-1==e.indexOf(l.prereq)?(a=l.prereq,winner_svalue=l.efficiency):-1==e.indexOf(skills.data[l.prereq].prereq)&&(a=skills.data[l.prereq].prereq,winner_svalue=l.efficiency):-1==e.indexOf(skills.data[skills.data[l.prereq].prereq].prereq)&&(a=skills.data[skills.data[l.prereq].prereq].prereq,winner_svalue=l.efficiency)))}),a}function calculateAllSkills(){winner_s1="",winner_s2="",winner_s3="",winner_s4="",winner_s5="";var e=[];$.each(skills.data,function(e,a){skills.data[e].efficiency=0,skills.data[e].cost="",1==a.active?skillEff(e,a):(skills.data[e].current_effect="",skills.data[e].current_effect2="",skills.data[e].current_effect3="")}),winner_s1=determineSkillWinner(e),e.push(winner_s1),winner_s2=determineSkillWinner(e),e.push(winner_s2),winner_s3=determineSkillWinner(e),e.push(winner_s3),winner_s4=determineSkillWinner(e),e.push(winner_s4),winner_s5=determineSkillWinner(e),calculateSkillTotals(),regenerateSkills();var a="";""!=winner_s1&&(a+='<button type="button" class="btn btn-primary mb-2 mr-2 col-12 col-md-6 col-xl-4" onclick="acceptSkill(\''+winner_s1+"')\">#1: "+skills.data[winner_s1].name+" "+skills.data[winner_s1].nickname+" ("+skills.data[winner_s1].cost+" SP - "+(skills.data[winner_s1].efficiency/skills.data[winner_s1].cost*100).toFixed(2)+'%) <span class="badge ml-2 badge-pill badge-'+("info"==skills.data[winner_s1].color?"success":skills.data[winner_s1].color)+'">'+skills.data[winner_s1].efficiency.toExponential(3)+"</span>"),""!=winner_s2&&(a+='<button type="button" class="btn btn-primary mb-2 mr-2 col-12 col-md-6 col-xl-4" onclick="acceptSkill(\''+winner_s2+"')\">#2: "+skills.data[winner_s2].name+" "+skills.data[winner_s2].nickname+" ("+skills.data[winner_s2].cost+" SP - "+(skills.data[winner_s2].efficiency/skills.data[winner_s2].cost*100).toFixed(2)+'%) <span class="badge ml-2 badge-pill badge-'+("info"==skills.data[winner_s2].color?"success":skills.data[winner_s2].color)+'">'+skills.data[winner_s2].efficiency.toExponential(3)+"</span>"),""!=winner_s3&&(a+='<button type="button" class="btn btn-primary mb-2 mr-2 col-12 col-md-6 col-xl-4" onclick="acceptSkill(\''+winner_s3+"')\">#3: "+skills.data[winner_s3].name+" "+skills.data[winner_s3].nickname+" ("+skills.data[winner_s3].cost+" SP - "+(skills.data[winner_s3].efficiency/skills.data[winner_s3].cost*100).toFixed(2)+'%) <span class="badge ml-2 badge-pill badge-'+("info"==skills.data[winner_s3].color?"success":skills.data[winner_s3].color)+'">'+skills.data[winner_s3].efficiency.toExponential(3)+"</span></button>"),""!=winner_s4&&(a+='<button type="button" class="btn btn-primary mb-2 mr-2 col-12 col-md-6 col-xl-4" onclick="acceptSkill(\''+winner_s4+"')\">#4: "+skills.data[winner_s4].name+" "+skills.data[winner_s4].nickname+" ("+skills.data[winner_s4].cost+" SP - "+(skills.data[winner_s4].efficiency/skills.data[winner_s4].cost*100).toFixed(2)+'%) <span class="badge ml-2 badge-pill badge-'+("info"==skills.data[winner_s4].color?"success":skills.data[winner_s4].color)+'">'+skills.data[winner_s4].efficiency.toExponential(3)+"</span></button>"),""!=winner_s5&&(a+='<button type="button" class="btn btn-primary mb-2 mr-2 col-12 col-md-6 col-xl-4" onclick="acceptSkill(\''+winner_s5+"')\">#5: "+skills.data[winner_s5].name+" "+skills.data[winner_s5].nickname+" ("+skills.data[winner_s5].cost+" SP - "+(skills.data[winner_s5].efficiency/skills.data[winner_s5].cost*100).toFixed(2)+'%) <span class="badge ml-2 badge-pill badge-'+("info"==skills.data[winner_s5].color?"success":skills.data[winner_s5].color)+'">'+skills.data[winner_s5].efficiency.toExponential(3)+"</span></button>"),a+="",$("#nextskill").empty().append(a)}function acceptSkill(e){gtag("event","Upgrades",{event_category:"Upgrades",event_action:"Accept",event_label:"SP"}),comeUndone=e,skills.data[e].level++,calculateSkillTotals(),adjustWeights(!1)}function undoSkill(){gtag("event","Upgrades",{event_category:"Upgrades",event_action:"Undo",event_label:"SP"}),""!=comeUndone&&(skills.data[comeUndone].level--,calculateSkillTotals(),adjustWeights(!1),comeUndone="")}function calculateAll(e,a){winner_e="";winner_value=0;var t=countArtifacts(artifacts.data)+1,l=artifact_costs[t],s=determineAverage(artifacts.data);return $.each(e.data,function(a,c){e.data[a].cost="",e.data[a].displayCost="",c.level>0&&1==c.active?e=oldEff(e,a,c):0==c.level&&-1!=l&&1==c.active?e=newEff(e,a,c,s,l,Object.keys(artifact_costs).length-1-t):(e.data[a].current_ad="",e.data[a].current_effect="")}),determineArtifactWinner(e,a,l,!0),e.totalAD=calculateTotalAD(e.data,a),e}function displayPct(e){return(e=displayTruncated(100*e))+"%"}function displayTruncated(e){return e>999999999999999?e=(e=e.toExponential(2)).replace(/\+/,""):e>999999999999?(e=(e/1e12).toFixed(2).replace(/\.?0+$/,""),e+="T"):e>999999999?(e=(e/1e9).toFixed(2).replace(/\.?0+$/,""),e+="B"):e>999999?(e=(e/1e6).toFixed(2).replace(/\.?0+$/,""),e+="M"):e>999?(e=(e/1e3).toFixed(2).replace(/\.?0+$/,""),e+="K"):isNaN(e)&&(e=e.toFixed(2).replace(/\.?0+$/,"")),e}function displayEffect(e,a){switch(a){case"multiply":return"x"+displayTruncated(e);case"add":return 0!=e&&(e-=1),e>0?"+"+displayTruncated(e):displayTruncated(e);case"add_skill":return e>0?"+"+displayTruncated(e):displayTruncated(e);case"multiply_pct":return"x"+displayPct(e);case"pct":return(e-=1)>0?"+"+displayPct(e):displayPct(e);case"pct_pos":return e>0?"+"+displayPct(e):displayPct(e)}}function storageAvailable(e){try{var a=window[e],t="__storage_test__";return a.setItem(t,t),a.removeItem(t),!0}catch(e){return e instanceof DOMException&&(22===e.code||1014===e.code||"QuotaExceededError"===e.name||"NS_ERROR_DOM_QUOTA_REACHED"===e.name)&&0!==a.length}}if(storageAvailable("localStorage")){var localArtifacts=JSON.parse(window.localStorage.getItem("artifacts"));null!=localArtifacts&&void 0===localArtifacts.data&&(localArtifacts.data=jQuery.extend(!0,{},localArtifacts)),null!=localArtifacts&&void 0!==localArtifacts.data&&$.each(localArtifacts.data,function(e,a){null!=artifacts.data[e]&&(artifacts.data[e].level=a.level,artifacts.data[e].active=a.active)}),artifacts.totalAD=calculateTotalAD(artifacts.data,!0);var localSkills=JSON.parse(window.localStorage.getItem("skills"));null!=localSkills&&void 0===localSkills.data&&(localSkills.data=jQuery.extend(!0,{},localSkills)),null!=localSkills&&void 0!==localSkills.data&&$.each(localSkills.data,function(e,a){null!=skills.data[e]&&(skills.data[e].level=a.max<a.level?a.max:a.level,skills.data[e].active=a.active)}),calculateSkillTotals(),$("#build").val(window.localStorage.getItem("build")),$("#hero").val(window.localStorage.getItem("hero")),$("#gold").val(window.localStorage.getItem("gold")),$("#active").val(window.localStorage.getItem("active")),$("#relic_factor").val(window.localStorage.getItem("relic_factor")),$("#spend").val(window.localStorage.getItem("spend")),$("#spend_decimal").val(window.localStorage.getItem("spend_decimal"));var ocd=window.localStorage.getItem("ocd");ocd?"pct"!=ocd.substring(0,3)&&1e3<parseInt(ocd)&&(ocd=1e3):ocd=1,$("#ocd").val(ocd.toString()),"1"==window.localStorage.getItem("splash")?($("#wet").prop("checked",!0),$("#dry").prop("checked",!1)):($("#wet").prop("checked",!1),$("#dry").prop("checked",!0)),toggleSplash(!1)}function storeData(){window.localStorage.setItem("artifacts",JSON.stringify(artifacts)),window.localStorage.setItem("skills",JSON.stringify(skills)),window.localStorage.setItem("build",$("#build").val()),window.localStorage.setItem("hero",$("#hero").val()),window.localStorage.setItem("gold",$("#gold").val()),window.localStorage.setItem("active",$("#active").val()),window.localStorage.setItem("relic_factor",$("#relic_factor").val()),window.localStorage.setItem("spend",$("#spend").val()),window.localStorage.setItem("spend_decimal",$("#spend_decimal").val()),window.localStorage.setItem("ocd",$("#ocd").val()),window.localStorage.setItem("splash",1==$("#wet").prop("checked")?1:0)}function avoidSci(e){var a;Math.abs(e)<1?(a=parseInt(e.toString().split("e-")[1]))&&(e*=Math.pow(10,a-1),e="0."+new Array(a).join("0")+e.toString().substring(2)):(a=parseInt(e.toString().split("+")[1]))>20&&(a-=20,e/=Math.pow(10,a),e+=new Array(a+1).join("0"));return e}function exportData(){$("#export_wrap").hide(),$("#import_wrap").hide();var e="";e+=$("#build").val()+"=",e+=$("#hero").val()+"=",e+=$("#gold").val()+"=",e+=$("#active").val()+"=",e+=(""==$("#spend").val()?75:$("#spend").val())+"=",e+=(""==$("#spend_decimal").val()?0:$("#spend_decimal").val())+"=",e+=(1==$("#wet").prop("checked")?1:0)+"=",e+=$("#relic_factor").val()+"=",e+=$("#ocd").val()+"=",$.each(artifacts.data,function(a,t){e+=a+"_",e+=t.active+"_",e+=(999999999999999<t.level?displayTruncated(t.level):avoidSci(t.level))+"|"}),e=e.slice(0,-1),e+="=",$.each(skills.data,function(a,t){e+=a+"_",e+=t.active+"_",e+=t.level+"|"}),e=e.slice(0,-1),$("#export").empty().text(e),$("#export_wrap").show()}function startImport(){$("#export_wrap").hide(),$("#import_wrap").hide(),$("#import").empty(),$("#import_wrap").show()}function importData(){var e=$("#import").val().trim().split("=");$("#build").val(e[0]),$("#hero").val(e[1]),$("#gold").val(e[2]),$("#active").val(e[3]),$("#spend").val(e[4]),$("#spend_decimal").val(e[5]),"1"==e[6]?($("#wet").prop("checked",!0),$("#dry").prop("checked",!1)):($("#wet").prop("checked",!1),$("#dry").prop("checked",!0)),toggleSplash(!1),$("#relic_factor").val(e[7]);var a=e[8];"pct"!=a.substring(0,3)&&1e3<parseInt(a)&&(a=1e3),$("#ocd").val(a.toString());var t=e[9].split("|");$.each(t,function(e,a){var t=a.split("_");artifacts.data[t[0]].active=parseInt(t[1]),artifacts.data[t[0]].level=parseFloat(t[2])});var l=e[10].split("|");$.each(l,function(e,a){var t=a.split("_");skills.data[t[0]].active=parseInt(t[1]),skills.data[t[0]].level=parseInt(t[2])}),$("#export_wrap").hide(),$("#import_wrap").hide(),generateArtifacts(),generateSkills(),adjustWeights(!0)}$('input[type="tel"]').on("focus",function(){$(this).data("fontSize",$(this).css("font-size")).css("font-size","16px")}).on("blur",function(){$(this).css("font-size",$(this).data("fontSize"))}),$('input[type="number"]').on("focus",function(){$(this).data("fontSize",$(this).css("font-size")).css("font-size","16px")}).on("blur",function(){$(this).css("font-size",$(this).data("fontSize"))}),$("#export_wrap").hide(),$("#import_wrap").hide(),$("#relicsuggs").hide(),generateArtifacts(),generateSkills(),0==halp&&adjustWeights(!0);